<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart India BSc IT Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #dfe9f3, #ffffff);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: #333;
    }

    .container {
      background-color: #ffffffee;
      padding: 30px 25px;
      border-radius: 15px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      max-width: 520px;
      width: 92%;
      text-align: center;
      animation: fadeIn 0.6s ease;
    }

    h2 {
      margin-bottom: 12px;
      font-size: 22px;
      color: #333;
    }

    .status {
      font-size: 14px;
      color: #555;
      margin-bottom: 10px;
    }

    .timer {
      font-size: 16px;
      color: #d10000;
      font-weight: bold;
      margin-bottom: 14px;
    }

    label {
      font-weight: 600;
      margin: 10px 0 5px;
      display: block;
      color: #333;
      text-align: left;
    }

    input, select {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
      background-color: #f9f9f9;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 12px;
      background-color: #007bff;
      color: white;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.25s;
    }

    button:hover:not(:disabled) {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }

    .footer {
      text-align: center;
      margin-top: 14px;
      font-size: 13px;
      color: #666;
    }

    .danger { color: #b00; }

    /* üîí QR Required message */
    .qr-locked {
      text-align: center;
      padding: 40px 30px;
      background-color: #fff;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      max-width: 420px;
      width: 90%;
      animation: fadeIn 0.6s ease;
    }
    .qr-locked h2 {
      font-size: 26px;
      color: #222;
      margin-bottom: 10px;
    }
    .qr-locked p {
      color: #666;
      font-size: 15px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>

  <!-- ‚úÖ FingerprintJS library -->
  <script src="https://openfpcdn.io/fingerprintjs/v3"></script>
</head>
<body>
  <div class="container" id="main-container">
    <h2>üìö Smart India üáÆüá≥<br />BSc IT Attendance (2023‚Äì26)</h2>
    <p id="qr-subject-year" class="info"></p>
    <div class="status" id="status">Initializing‚Ä¶</div>
    <div class="timer" id="timer">‚è≥ Time left: 2:00</div>

    <form
      id="attendance-form"
      action="https://mullet-brave-vulture.ngrok-free.app/webhook-test/0f62c736-a6d1-41cc-b72c-face086860c5"
      method="POST"
      autocomplete="off"
    >
      <label for="student_id">üéì Student ID</label>
      <input id="student_id" name="student_id" placeholder="444-9832" required />

      <label for="email">üìß Email</label>
      <input id="email" name="email" type="email" placeholder="raj.bscitstudent23.8933@cimage.in" required />

      <label for="roll">üî¢ Roll No</label>
      <input id="roll" name="roll" placeholder="47" required />

      <label for="batch">üìÜ Batch</label>
      <select id="batch" name="batch" required>
        <option value="">Select batch</option>
        <option>1</option><option>2</option><option>3</option><option>4</option>
      </select>

      <label for="section">üè´ Section</label>
      <select id="section" name="section" required>
        <option value="">Select section</option>
        <option>A</option><option>B</option><option>C</option>
      </select>

      <input type="hidden" name="latitude" id="latitude" />
      <input type="hidden" name="longitude" id="longitude" />
      <input type="hidden" name="current_time" id="current_time" />
      <input type="hidden" name="fingerprint" id="fingerprint" />
      <input type="hidden" name="fingerprint_version" value="fingerprintjs_v3_sha256" />

      <button type="submit" id="submitBtn" disabled>üì© Submit Attendance</button>
    </form>

    <div class="footer" id="footerText">
      GPS + Fingerprint secured ‚úÖ | Smart India üõ∞Ô∏è
    </div>
  </div>

  <script>
    // ---------- ‚úÖ QR VALIDATION ----------
    const QR_SECRET = "mySuperSecretKey123";

    async function sha256(text) {
      const data = new TextEncoder().encode(text);
      const hashBuffer = await crypto.subtle.digest("SHA-256", data);
      return Array.from(new Uint8Array(hashBuffer))
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
    }

    function getQRParams() {
      const params = new URLSearchParams(window.location.hash.slice(1));
      return {
        subject: params.get("subject"),
        year: params.get("year"),
        timestamp: params.get("timestamp"),
        expires: params.get("expires"),
        hash: params.get("hash"),
      };
    }

    async function verifyQRLink() {
      const { subject, year, timestamp, expires, hash } = getQRParams();
      if (!subject || !year || !timestamp || !expires || !hash) {
        showQRRequired();
        throw new Error("Missing QR parameters");
      }
      const expiryTime = parseInt(expires, 10);
      if (Date.now() > expiryTime) {
        document.body.innerHTML = `<div class='qr-locked'><h2>‚õî QR Code Expired</h2><p>This QR code is no longer valid.</p></div>`;
        throw new Error("QR expired");
      }
      const rawData = `subject=${subject}&year=${year}&timestamp=${timestamp}&expires=${expires}`;
      const expectedHash = await sha256(rawData + QR_SECRET);
      if (expectedHash !== hash) {
        document.body.innerHTML = `<div class='qr-locked'><h2>üö´ Invalid QR Code</h2><p>This QR code has been tampered with.</p></div>`;
        throw new Error("QR hash mismatch");
      }
      document.getElementById("qr-subject-year").textContent = `üìò Subject: ${subject} | üóìÔ∏è Year: ${year}`;
    }

    // üîí Show attractive locked screen
    function showQRRequired() {
      document.body.innerHTML = `
        <div class="qr-locked">
          <h2>üîí QR Code Required</h2>
          <p>This form can only be opened via a valid QR code.</p>
        </div>`;
    }

    // ---------- ‚úÖ CONFIG ----------
    const COLLEGE_LAT = 25.623374;
    const COLLEGE_LNG = 85.099183;
    const ALLOWED_RADIUS_METERS = 100;
    const FP_EXPIRY_MINUTES = 2;
    const RESUBMIT_LOCK_MINUTES = 40;

    const form = document.getElementById("attendance-form");
    const submitBtn = document.getElementById("submitBtn");
    const statusEl = document.getElementById("status");
    const timerEl = document.getElementById("timer");
    const footerText = document.getElementById("footerText");
    const fpInput = document.getElementById("fingerprint");

    function setStatus(msg, err = false) {
      statusEl.textContent = msg;
      statusEl.classList.toggle("danger", err);
    }

    function disableForm(msg) {
      submitBtn.disabled = true;
      footerText.textContent = msg;
    }

    function enableForm(msg) {
      submitBtn.disabled = false;
      footerText.textContent = msg;
    }

    // ‚úÖ Fingerprint
    async function generateFingerprint() {
      try {
        const fpPromise = FingerprintJS.load();
        const fp = await fpPromise;
        const result = await fp.get();
        const raw = `${result.visitorId}-${navigator.userAgent}-${screen.width}x${screen.height}`;
        const hashed = await sha256(raw);
        const expiry = Date.now() + FP_EXPIRY_MINUTES * 60 * 1000;
        sessionStorage.setItem("fingerprint", hashed);
        sessionStorage.setItem("fp_expiry", expiry);
        fpInput.value = hashed;
        setStatus("Fingerprint ready ‚úÖ");
      } catch {
        setStatus("Unable to create fingerprint ‚ùå", true);
      }
    }

    function fingerprintValid() {
      const expiry = parseInt(sessionStorage.getItem("fp_expiry") || "0");
      return Date.now() <= expiry;
    }

    // ‚úÖ GPS + Distance
    function distance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(ŒîœÜ / 2) ** 2 +
        Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function getLocation() {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: true,
          timeout: 15000,
        });
      });
    }

    // ‚úÖ Timer
    function startTimer(minutes) {
      let total = minutes * 60;
      const int = setInterval(() => {
        if (total <= 0) {
          clearInterval(int);
          disableForm("‚õî Time expired.");
          return;
        }
        const m = Math.floor(total / 60);
        const s = total % 60;
        timerEl.textContent = `‚è≥ Time left: ${m}:${s < 10 ? "0" + s : s}`;
        total--;
      }, 1000);
    }

    // ‚úÖ Submit Lock
    function checkLock() {
      const last = parseInt(localStorage.getItem("last_submit_time") || "0");
      if ((Date.now() - last) / 60000 < RESUBMIT_LOCK_MINUTES) {
        const remain = Math.ceil(
          RESUBMIT_LOCK_MINUTES - (Date.now() - last) / 60000
        );
        disableForm(`üïí Already submitted. Try again in ${remain} min.`);
        setStatus("Submission locked", true);
        return true;
      }
      return false;
    }
    function setLock() {
      localStorage.setItem("last_submit_time", Date.now().toString());
    }

    // ‚úÖ Init
    (async function init() {
      try {
        await verifyQRLink();
      } catch { return; }

      if (checkLock()) return;

      setStatus("üîç Verifying identity & location...");
      startTimer(FP_EXPIRY_MINUTES);
      await generateFingerprint();

      try {
        const pos = await getLocation();
        const dist = distance(
          pos.coords.latitude,
          pos.coords.longitude,
          COLLEGE_LAT,
          COLLEGE_LNG
        );
        if (dist > ALLOWED_RADIUS_METERS) {
          setStatus(`Outside campus by ${Math.round(dist)}m`, true);
          disableForm("üö´ Outside allowed area");
          return;
        }
        setStatus("Location verified ‚úÖ");
        enableForm("GPS + Fingerprint secured ‚úÖ | You may submit");
      } catch {
        setStatus("Location access denied ‚ùå", true);
        disableForm("‚ùå Enable GPS to proceed");
      }
    })();

    // ‚úÖ Submit
    form.addEventListener("submit", async e => {
      e.preventDefault();
      if (!fingerprintValid()) {
        alert("Fingerprint expired. Reload form.");
        disableForm("Fingerprint expired");
        return;
      }
      setStatus("Submitting‚Ä¶");
      submitBtn.disabled = true;
      const data = new FormData(form);
      try {
        const res = await fetch(form.action, { method: "POST", body: data });
        if (res.ok) {
          setStatus("‚úÖ Submitted successfully");
          disableForm("‚úÖ Attendance submitted");
          setLock();
        } else throw new Error("Network error");
      } catch {
        setStatus("‚ùå Submission failed", true);
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
